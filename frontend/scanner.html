<!DOCTYPE html>
<html>
<head>
  <title>QR Scanner</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>

<div class="container">
  <h1>Scan QR</h1>

  <div class="card">
    <select id="scanType">
      <option value="gate">Gate</option>
      <option value="washroom">Washroom</option>
    </select>

    <div id="reader" style="width:330px; margin:auto; margin-top:20px;"></div>
    <div id="result" style="margin-top:15px; font-size:18px;"></div>

    <!-- ✅ Scan Next Button -->
    <button id="scanNextBtn" type="button" style="display:none; margin-top:15px;">
      Scan Next
    </button>
  </div>
</div>

<script>
  const result = document.getElementById("result");
  const scanNextBtn = document.getElementById("scanNextBtn");

  const qr = new Html5Qrcode("reader");
  let isProcessing = false;

  function safe(v) {
    return (v === undefined || v === null || v === "") ? "-" : v;
  }

  function showScanNextButton() {
    scanNextBtn.style.display = "inline-block";
  }

  function hideScanNextButton() {
    scanNextBtn.style.display = "none";
  }

  function resetAndScanNext() {
    isProcessing = false;
    result.innerHTML = "";
    hideScanNextButton();
    startScanner();
  }

  scanNextBtn.addEventListener("click", resetAndScanNext);

  function startScanner() {
    qr.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 250 },
      qrText => {
        if (isProcessing) return;
        isProcessing = true;

        const action = document.getElementById("scanType").value;

        fetch(`${qrText}?action=${action}`)
          .then(r => r.json())
          .then(res => {
            if (!res.success) {
              result.innerHTML = `<h2 style="color:red;">${safe(res.message)} ❌</h2>`;
              showScanNextButton();
              return;
            }

            result.innerHTML = `
              <h2 style="color:green;">${safe(res.message)} ✔</h2>

              <div style="margin-top:10px;">
                <b>Name:</b> ${safe(res.name)}<br>
                <b>Phone:</b> ${safe(res.phone)}<br>
                <b>Manual Code:</b> ${safe(res.manualCode)}<br>
                <b>Aadhaar:</b> ${safe(res.aadhaarNumber)}<br>

                <br>

                <b>Address:</b> ${safe(res.address)}<br>
                <b>Car Voucher No:</b> ${safe(res.carVoucherNumber)}<br>
                <b>Car Number:</b> ${safe(res.carNumber)}<br>
                <b>Zone:</b> ${res.zone ? res.zone : "<span style='color:gray;'>Not Set</span>"}<br>

                <br>

                <b>Gate:</b>
                <span style="color:${res.gateStatus === "IN" ? "green" : "red"}">${safe(res.gateStatus)}</span><br>

                <b>Washroom:</b>
                <span style="color:${res.washroomStatus === "IN" ? "blue" : "gray"}">${safe(res.washroomStatus)}</span><br><br>

                <small>Updated at: ${new Date(res.time).toLocaleTimeString()}</small>
              </div>
            `;

            // ✅ result stays, show Scan Next
            showScanNextButton();
          })
          .catch(() => {
            result.innerHTML = `<h2 style="color:red;">Scan failed ❌</h2>`;
            showScanNextButton();
          })
          .finally(() => {
            // ✅ Stop scanner and WAIT for user to click "Scan Next"
            qr.stop();
          });
      }
    );
  }

  startScanner();
</script>

</body>
</html>
