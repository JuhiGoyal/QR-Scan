<!DOCTYPE html>
<html>
<head>
  <title>QR Scanner</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>

<div class="container">
  <h1>Scan QR</h1>

  <div class="card">

    <!-- ✅ LOGIN SECTION -->
    <div id="loginBox" style="margin-bottom:15px;">
      <h3 style="margin:0 0 10px 0;">Scanner Login</h3>
      <input id="scannerPassword" type="password" placeholder="Enter Scanner Password" />
      <button id="loginBtn" type="button" style="margin-top:10px;">Login</button>
      <div id="loginMsg" style="margin-top:10px;"></div>
    </div>

    <!-- ✅ SCAN SECTION -->
    <div id="scanBox" style="display:none;">
      <select id="scanType">
        <option value="gate">Gate</option>
        <option value="washroom">Washroom</option>
      </select>

      <div id="reader" style="width:330px; margin:auto; margin-top:20px;"></div>
      <div id="result" style="margin-top:15px; font-size:18px;"></div>

      <!-- ✅ Scan Next Button -->
      <button id="scanNextBtn" type="button" style="display:none; margin-top:15px;">
        Scan Next
      </button>

      <!-- ✅ Update This User Button -->
      <button id="updateBtn" type="button" style="display:none; margin-top:15px; margin-left:10px;">
        Update This User
      </button>

      <!-- ✅ Logout -->
      <button id="logoutBtn" type="button" style="margin-top:15px; margin-left:10px;">
        Logout
      </button>
    </div>

  </div>
</div>

<script>
  // ✅ BACKEND BASE
  const API_BASE = "https://qr-backend-5qot.onrender.com";

  const loginBox = document.getElementById("loginBox");
  const scanBox = document.getElementById("scanBox");
  const loginMsg = document.getElementById("loginMsg");
  const result = document.getElementById("result");
  const scanNextBtn = document.getElementById("scanNextBtn");

  // ✅ Update button vars
  const updateBtn = document.getElementById("updateBtn");
  let lastScannedUserId = null;

  const TOKEN_KEY = "scannerToken";

  const qr = new Html5Qrcode("reader");
  let isProcessing = false;

  function safe(v) {
    return (v === undefined || v === null || v === "") ? "-" : v;
  }

  function showScanNextButton() {
    scanNextBtn.style.display = "inline-block";
  }

  function hideScanNextButton() {
    scanNextBtn.style.display = "none";
  }

  function showUpdateButton() {
    updateBtn.style.display = "inline-block";
  }

  function hideUpdateButton() {
    updateBtn.style.display = "none";
  }

  function getToken() {
    return localStorage.getItem(TOKEN_KEY);
  }

  function setToken(token) {
    localStorage.setItem(TOKEN_KEY, token);
  }

  function clearToken() {
    localStorage.removeItem(TOKEN_KEY);
  }

  function showLogin() {
    loginBox.style.display = "block";
    scanBox.style.display = "none";
  }

  function showScanner() {
    loginBox.style.display = "none";
    scanBox.style.display = "block";
  }

  // ✅ Login
  document.getElementById("loginBtn").addEventListener("click", async () => {
    const password = document.getElementById("scannerPassword").value.trim();

    if (!password) {
      loginMsg.innerHTML = `<span style="color:red;">Password required</span>`;
      return;
    }

    loginMsg.innerHTML = "⏳ Logging in...";

    try {
      const r = await fetch(`${API_BASE}/scanner-login`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ password })
      });

      const data = await r.json();

      if (!data.success) {
        loginMsg.innerHTML = `<span style="color:red;">${safe(data.message)} ❌</span>`;
        return;
      }

      setToken(data.token);
      loginMsg.innerHTML = `<span style="color:green;">Login success ✅</span>`;

      showScanner();
      startScanner();

    } catch (e) {
      loginMsg.innerHTML = `<span style="color:red;">Login failed ❌</span>`;
    }
  });

  // ✅ Logout
  document.getElementById("logoutBtn").addEventListener("click", () => {
    clearToken();
    result.innerHTML = "";
    hideScanNextButton();

    // ✅ also reset update button + id
    hideUpdateButton();
    lastScannedUserId = null;

    try { qr.stop(); } catch(e) {}
    showLogin();
  });

  function resetAndScanNext() {
    isProcessing = false;
    result.innerHTML = "";
    hideScanNextButton();

    // ✅ reset update button + id
    hideUpdateButton();
    lastScannedUserId = null;

    startScanner();
  }

  scanNextBtn.addEventListener("click", resetAndScanNext);

  // ✅ Update button click
  updateBtn.addEventListener("click", async () => {
    const token = getToken();
    if (!token || !lastScannedUserId) {
      alert("User not available for update");
      return;
    }

    try {
      const r = await fetch(`${API_BASE}/user/${lastScannedUserId}`, {
        headers: { "Authorization": `Bearer ${token}` }
      });

      const data = await r.json();
      if (!data.success) {
        alert(data.message || "Unable to fetch user");
        return;
      }

      // ✅ save for update page autofill
      localStorage.setItem("updateUserData", JSON.stringify(data.user));

      // ✅ redirect to update
      window.location.href = "update.html?from=scanner";
    } catch (e) {
      alert("Failed to open update");
    }
  });

  // ✅ Start scanner
  function startScanner() {
    const token = getToken();
    if (!token) {
      showLogin();
      return;
    }

    qr.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 250 },
      qrText => {
        if (isProcessing) return;
        isProcessing = true;

        const action = document.getElementById("scanType").value;

        fetch(`${qrText}?action=${action}`, {
          headers: {
            "Authorization": `Bearer ${token}`
          }
        })
          .then(r => r.json())
          .then(res => {

            // ✅ session expired handling
            if (res.message && (res.message.includes("Invalid/Expired") || res.message.includes("login required"))) {
              clearToken();
              result.innerHTML = `<h2 style="color:red;">Session expired. Login again ❌</h2>`;
              showLogin();
              return;
            }

            if (!res.success) {
              result.innerHTML = `<h2 style="color:red;">${safe(res.message)} ❌</h2>`;
              showScanNextButton();
              hideUpdateButton();
              lastScannedUserId = null;
              return;
            }

            // ✅ Extract mongo userId from scanned QR URL
            try {
              const urlObj = new URL(qrText);
              const parts = urlObj.pathname.split("/");
              lastScannedUserId = parts[parts.length - 1]; // mongo id
            } catch (e) {
              lastScannedUserId = null;
            }

            result.innerHTML = `
              <h2 style="color:green;">${safe(res.message)} ✔</h2>

              <div style="margin-top:10px;">
                <b>Serial No:</b> ${safe(res.serialNo)}<br>

                <b>Name:</b> ${safe(res.name)}<br>
                <b>Phone:</b> ${safe(res.phone)}<br>
                <b>Manual Code:</b> ${safe(res.manualCode)}<br>
                <b>Aadhaar:</b> ${safe(res.aadhaarNumber)}<br>

                <br>

                <b>Address:</b> ${safe(res.address)}<br>
                <b>Car Voucher No:</b> ${safe(res.carVoucherNumber)}<br>
                <b>Car Number:</b> ${safe(res.carNumber)}<br>

                <b>Zone Day 1:</b> ${res.zoneDay1 ? res.zoneDay1 : "<span style='color:gray;'>Not Set</span>"}<br>
                <b>Zone Day 2:</b> ${res.zoneDay2 ? res.zoneDay2 : "<span style='color:gray;'>Not Set</span>"}<br>

                <b>Referred By:</b> ${safe(res.referredBy)}<br>

                <br>

                <b>Gate:</b>
                <span style="color:${res.gateStatus === "IN" ? "green" : "red"}">${safe(res.gateStatus)}</span><br>

                <b>Washroom:</b>
                <span style="color:${res.washroomStatus === "IN" ? "blue" : "gray"}">${safe(res.washroomStatus)}</span><br><br>

                <small>Updated at: ${new Date(res.time).toLocaleTimeString()}</small>
              </div>
            `;

            showScanNextButton();

            // ✅ show update button ONLY if user id found
            if (lastScannedUserId) {
              showUpdateButton();
            } else {
              hideUpdateButton();
            }
          })
          .catch(() => {
            result.innerHTML = `<h2 style="color:red;">Scan failed ❌</h2>`;
            showScanNextButton();
            hideUpdateButton();
            lastScannedUserId = null;
          })
          .finally(() => {
            qr.stop();
          });
      }
    );
  }

  if (getToken()) {
    showScanner();
    startScanner();
  } else {
    showLogin();
  }
</script>

</body>
</html>
