<!DOCTYPE html>
<html>
<head>
  <title>User QR Code</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="container">
  <h1>QR Generated</h1>

  <div class="card" id="card" style="display:none;">
    <img id="qrImg" width="260" style="border:2px solid #1e4db7; border-radius:10px;"><br><br>

    <p><b>Name:</b> <span id="name"></span></p>
    <p><b>Phone:</b> <span id="phone"></span></p>
    <p><b>Manual Code:</b> <span id="manual" style="font-size:22px; color:#bf0000;"></span></p>

    <!-- ✅ Download Button -->
    <button id="downloadBtn" type="button" style="display:none;">
      Download QR
    </button>

    <br><br>

    <button type="button" onclick="window.location.href='register.html'">
      Register Another User
    </button>
  </div>

  <div id="error" style="display:none;">
    <h3 style="color:red;">❌ No QR data found</h3>
    <button type="button" onclick="window.location.href='register.html'">Go to Registration</button>
  </div>
</div>

<script>
  // Prevent Back Navigation
  history.pushState(null, "", location.href);
  window.onpopstate = () => history.go(1);

  // ✅ Download function
  async function downloadQR(qrUrl, manualCode) {
    try {
      if (!qrUrl || !manualCode) {
        alert("QR data not available");
        return;
      }

      const response = await fetch(qrUrl);
      if (!response.ok) throw new Error("Failed to fetch QR image");

      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = `${manualCode}.png`;   // ✅ filename = manualCode
      document.body.appendChild(a);
      a.click();
      a.remove();

      window.URL.revokeObjectURL(url);
    } catch (err) {
      console.error("Download Error:", err);
      alert("Download failed");
    }
  }

  // Get stored data
  const data = JSON.parse(localStorage.getItem("qrUser"));

  if (!data || !data.qrImageUrl || !data.manualCode) {
    document.getElementById("error").style.display = "block";
  } else {
    document.getElementById("card").style.display = "block";

    document.getElementById("qrImg").src = data.qrImageUrl;
    document.getElementById("name").innerText = data.name || "-";
    document.getElementById("phone").innerText = data.phone || "-";
    document.getElementById("manual").innerText = data.manualCode;

    // ✅ Show download button & attach handler
    const btn = document.getElementById("downloadBtn");
    btn.style.display = "inline-block";
    btn.onclick = () => downloadQR(data.qrImageUrl, data.manualCode);
  }
</script>

</body>
</html>
