<!DOCTYPE html>
<html>
<head>
  <title>User QR Code</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="container">
  <h1>QR Generated</h1>

  <div class="card" id="card" style="display:none;">
    <img id="qrImg" width="260" style="border:2px solid #1e4db7; border-radius:10px;"><br><br>

    <!-- ✅ Serial No -->
    <p><b>Serial No:</b> <span id="serialNo"></span></p>

    <p><b>Name:</b> <span id="name"></span></p>
    <p><b>Phone:</b> <span id="phone"></span></p>
    <p><b>Aadhaar:</b> <span id="aadhaar"></span></p>

    <p><b>Address:</b> <span id="address"></span></p>
    <p><b>Car Voucher No:</b> <span id="carVoucherNumber"></span></p>
    <p><b>Car Number:</b> <span id="carNumber"></span></p>

    <!-- ✅ Zones + Preferred By -->
    <p><b>Zone Day 1:</b> <span id="zoneDay1"></span></p>
    <p><b>Zone Day 2:</b> <span id="zoneDay2"></span></p>
    <p><b>Referred By:</b> <span id="referredBy"></span></p>

    <p><b>Manual Code:</b> <span id="manual" style="font-size:22px; color:#bf0000;"></span></p>

    <!-- ✅ Download Button -->
    <button id="downloadBtn" type="button" style="display:none;">
      Download QR
    </button>

    <br><br>

    <button type="button" onclick="window.location.href='register.html'">
      Register Another User
    </button>
  </div>

  <div id="error" style="display:none;">
    <h3 style="color:red;">❌ No QR data found</h3>
    <button type="button" onclick="window.location.href='register.html'">Go to Registration</button>
  </div>
</div>

<script>
  // Prevent Back Navigation
  history.pushState(null, "", location.href);
  window.onpopstate = () => history.go(1);

  function safe(v) {
    return (v === undefined || v === null || v === "") ? "-" : v;
  }

  async function downloadQR(qrUrl, manualCode) {
    try {
      if (!qrUrl || !manualCode) {
        alert("QR data not available");
        return;
      }

      const response = await fetch(qrUrl);
      if (!response.ok) throw new Error("Failed to fetch QR image");

      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = `${manualCode}.png`;
      document.body.appendChild(a);
      a.click();
      a.remove();

      window.URL.revokeObjectURL(url);
    } catch (err) {
      console.error("Download Error:", err);
      alert("Download failed");
    }
  }

  const data = JSON.parse(localStorage.getItem("qrUser"));

  if (!data || !data.qrImageUrl || !data.manualCode) {
    document.getElementById("error").style.display = "block";
  } else {
    document.getElementById("card").style.display = "block";

    document.getElementById("qrImg").src = data.qrImageUrl;

    // ✅ Serial No
    document.getElementById("serialNo").innerText = safe(data.serialNo);

    document.getElementById("name").innerText = safe(data.name);
    document.getElementById("phone").innerText = safe(data.phone);
    document.getElementById("aadhaar").innerText = safe(data.aadhaarNumber);

    document.getElementById("address").innerText = safe(data.address);
    document.getElementById("carVoucherNumber").innerText = safe(data.carVoucherNumber);
    document.getElementById("carNumber").innerText = safe(data.carNumber);

    document.getElementById("zoneDay1").innerHTML = data.zoneDay1 ? data.zoneDay1 : "<span style='color:gray;'>Not Set</span>";
    document.getElementById("zoneDay2").innerHTML = data.zoneDay2 ? data.zoneDay2 : "<span style='color:gray;'>Not Set</span>";
    document.getElementById("referredBy").innerText = safe(data.referredBy);

    document.getElementById("manual").innerText = safe(data.manualCode);

    const btn = document.getElementById("downloadBtn");
    btn.style.display = "inline-block";
    btn.onclick = () => downloadQR(data.qrImageUrl, data.manualCode);
  }
</script>

</body>
</html>
